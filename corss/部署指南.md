# Base到Aptos CCTP跨链桥部署指南

## 📋 项目概述

这是一个完整的Base测试网到Aptos测试网的CCTP（Cross-Chain Transfer Protocol）跨链桥实现，支持USDC的跨链转账。

## 🏗️ 项目结构

```
corss1.0/
├── sources/                    # Move合约源码
│   ├── cctp_receiver.move     # CCTP接收合约
│   └── cctp_config.move       # 配置常量
├── src/                       # TypeScript源码
│   ├── base-sender.ts         # Base链发送器
│   ├── circle-attestation.ts  # Circle签名获取
│   ├── aptos-receiver.ts      # Aptos接收器
│   └── cross-chain-orchestrator.ts # 跨链编排器
├── examples/                  # 示例代码
│   └── complete-example.ts    # 完整示例
├── Move.toml                  # Move项目配置
├── package.json               # Node.js依赖
└── 部署指南.md                # 本文档
```

## 🚀 快速开始

### 1. 环境准备

#### 安装依赖
```bash
# 安装Node.js依赖
npm install

# 安装Aptos CLI
curl -fsSL "https://aptos.dev/scripts/install_cli.py" | python3
```

#### 网络要求
- **Base Sepolia测试网**: 需要测试ETH和USDC
- **Aptos测试网**: 需要测试APT作为gas费

### 2. 获取测试资金

#### Base Sepolia测试网
1. **获取测试ETH**: https://www.alchemy.com/faucets/base-sepolia
2. **获取测试USDC**: https://faucet.circle.com/ (选择Base Sepolia)

#### Aptos测试网
1. **获取测试APT**: https://aptoslabs.com/testnet-faucet

### 3. 部署Move合约

```bash
# 初始化Aptos账户（如果没有）
aptos init

# 编译Move合约
aptos move compile

# 部署到Aptos测试网
aptos move publish
```

> ⚠️ **重要**: 部署成功后，更新 `src/aptos-receiver.ts` 中的 `CROSS_CHAIN_MODULE_ADDRESS` 为实际部署地址

### 4. 配置参数

编辑 `examples/complete-example.ts` 中的配置：

```typescript
const CONFIG = {
  BASE_PRIVATE_KEY: 'your_base_private_key_here',
  APTOS_PRIVATE_KEY: 'your_aptos_private_key_here',
  APTOS_RECIPIENT: 'your_aptos_address_here',
  USDC_AMOUNT: '1.0',
};
```

### 5. 运行示例

```bash
# 创建Aptos测试账户
npm run example create-account

# 检查余额
npm run example balance

# 执行跨链转账
npm run example cross-chain
```

## 📖 详细使用说明

### Move合约接口

#### `cctp_receiver::receive_cctp_usdc`
```move
public entry fun receive_cctp_usdc(
    account: &signer,
    message_bytes: vector<u8>,
    attestation: vector<u8>
)
```

- **功能**: 接收CCTP消息并铸造USDC
- **参数**:
  - `account`: 接收者账户
  - `message_bytes`: Base链生成的跨链消息
  - `attestation`: Circle提供的签名证明

#### `cctp_receiver::receive_cctp_and_add_liquidity` (预留)
```move
public entry fun receive_cctp_and_add_liquidity(
    account: &signer,
    message_bytes: vector<u8>,
    attestation: vector<u8>,
    pool_address: address,
    liquidity_amount: u64
)
```

- **功能**: 接收USDC并添加流动性（预留接口）
- **状态**: 🚧 待实现

### TypeScript API

#### BaseCCTPSender
```typescript
import { BaseCCTPSender } from './src/base-sender';

const sender = new BaseCCTPSender();

// 执行跨链发送
const result = await sender.executeFullCrossChain({
  amount: '10.0',
  recipientAddress: 'aptos_address',
  signer: ethers_signer
});
```

#### AptosCCTPReceiver
```typescript
import { aptosCCTPReceiver } from './src/aptos-receiver';

// 接收CCTP USDC
const result = await aptosCCTPReceiver.receiveCCTPUSDC({
  messageBytes: 'message_from_base',
  attestation: 'circle_signature',
  recipientPrivateKey: 'aptos_private_key'
});
```

#### CrossChainOrchestrator (推荐)
```typescript
import { crossChainOrchestrator } from './src/cross-chain-orchestrator';

// 一键完成整个跨链流程
const result = await crossChainOrchestrator.executeCrossChain({
  amount: '10.0',
  recipientAddress: 'aptos_address',
  baseSigner: ethers_signer,
  aptosPrivateKey: 'aptos_key',
  onProgress: (step, details) => console.log(step)
});
```

## 🔧 技术原理

### 跨链流程
1. **Base链**: 调用 `depositForBurn` 烧毁USDC，生成跨链消息
2. **Circle**: 验证消息并提供签名证明 (attestation)
3. **Aptos链**: 验证签名并铸造USDC到指定地址

### 安全机制
- **Circle签名验证**: 防止伪造跨链消息
- **Nonce防重放**: 确保消息不被重复处理
- **原子操作**: Move合约确保接收和处理在同一交易中完成

## 🔍 测试和调试

### 编译检查
```bash
# Move合约编译
aptos move compile

# TypeScript编译
npm run build
```

### 单元测试
```bash
# Move合约测试
aptos move test

# TypeScript测试
npm run test
```

### 调试技巧
1. **查看交易**: 在 [Base Sepolia Explorer](https://sepolia.basescan.org/) 和 [Aptos Explorer](https://explorer.aptoslabs.com/) 查看交易详情
2. **监控事件**: 合约会发出事件，便于追踪状态
3. **Circle API**: 可以直接查询 Circle API 获取签名状态

## ⚠️ 注意事项

### 重要提醒
1. **仅用于测试网**: 当前配置仅适用于测试环境
2. **私钥安全**: 不要在生产环境中硬编码私钥
3. **网络稳定**: 跨链需要网络连接稳定，建议在良好网络环境下操作
4. **Gas费准备**: 确保两条链都有足够的gas费

### 常见问题
1. **"USDC余额不足"**: 请到Circle faucet获取测试USDC
2. **"Aptos账户不存在"**: 请先到faucet获取测试APT激活账户
3. **"Circle签名超时"**: 等待时间较长是正常的，通常1-3分钟

## 🔄 后续扩展

### 计划功能
1. **流动性添加**: 跨链后自动添加到DEX流动性池
2. **多链支持**: 支持更多EVM链到Aptos的跨链
3. **批量操作**: 支持批量跨链转账
4. **Web界面**: 提供用户友好的Web界面

### 集成指南
```typescript
// 集成到现有项目
import { crossChainOrchestrator } from 'base-aptos-cctp-bridge';

// 在你的应用中使用
const bridge = crossChainOrchestrator;
const result = await bridge.executeCrossChain(params);
```

## 📞 支持和反馈

如有问题或建议，请：
1. 查看代码注释和错误日志
2. 检查网络配置和余额
3. 参考Circle官方文档
4. 提交Issue或联系开发团队

---

🎉 **恭喜！** 你现在可以在Base和Aptos之间自由转移USDC了！